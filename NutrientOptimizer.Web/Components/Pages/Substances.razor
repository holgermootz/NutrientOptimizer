@page "/substances"
@using NutrientOptimizer.Core
@using NutrientOptimizer.Core.Data
@using NutrientOptimizer.Web.Services
@using MudBlazor
@inject SaltDatabaseService SaltService

<PageTitle>Substances Library</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-8">
    <MudStack Spacing="4">
        <!-- Header -->
        <div>
            <MudText Typo="Typo.h4" GutterBottom="true">Nutrient Substances Library</MudText>
            <MudText Typo="Typo.body2">
                Browse @Salts?.Count total nutrients and fertilizers organized by type
            </MudText>
        </div>

        @if (Salts == null || Salts.Count == 0)
        {
            <MudAlert Severity="Severity.Warning">
                No substances data loaded from database.
            </MudAlert>
        }
        else
        {
            <!-- Search and Filter -->
            <MudStack Row="true" Spacing="2" Style="margin-bottom: 20px;">
                <MudTextField @bind-Value="SearchTerm" Placeholder="Search substances..." 
                    Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" 
                    Style="flex: 1;" />
                
                <MudSelect @bind-Value="SelectedGroup" Label="Filter by Group" Variant="Variant.Filled" Style="min-width: 200px;">
                    <MudSelectItem Value="@(null as SaltGroup?)">All Groups</MudSelectItem>
                    @foreach (var group in Enum.GetValues(typeof(SaltGroup)).Cast<SaltGroup>())
                    {
                        <MudSelectItem Value="@((SaltGroup?)group)">@group</MudSelectItem>
                    }
                </MudSelect>
            </MudStack>

            <!-- Tabs for Commercial vs Raw -->
            <MudTabs Elevation="0" ActivePanelIndex="@_activeTabIndex" ApplyEffectsToContainer="true">
                <!-- Commercial Fertilizers Tab -->
                <MudTabPanel Text="?? Commercial Fertilizers">
                    @{
                        var commercialSalts = FilteredSaltsByType(SubstanceType.Commercial);
                    }
                    
                    <div style="padding-top: 20px;">
                        @if (commercialSalts.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info">
                                No commercial fertilizers match your filters.
                            </MudAlert>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Style="margin-bottom: 10px;">
                                Showing @commercialSalts.Count substances
                            </MudText>
                            
                            <!-- Group by primary nutrient within Commercial -->
                            @foreach (var grouping in commercialSalts.GroupBy(s => s.Group).OrderBy(g => g.Key.ToString()))
                            {
                                <MudCard Style="margin-bottom: 16px;">
                                    <MudCardHeader>
                                        <CardHeaderContent>
                                            <MudText Typo="Typo.h6">@grouping.Key</MudText>
                                        </CardHeaderContent>
                                        <CardHeaderActions>
                                            <MudBadge Content="@grouping.Count()" Color="Color.Primary" Overlap="true" Class="mx-2">
                                                <MudIcon Icon="@Icons.Material.Filled.Layers" />
                                            </MudBadge>
                                        </CardHeaderActions>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <MudDataGrid Items="@grouping.OrderBy(x => x.Name).ToList()" Hover="true" Striped="true" Dense="true" Bordered="true">
                                            <Columns>
                                                <PropertyColumn Property="x => x.Name" Title="Name" />
                                                <PropertyColumn Property="x => x.Formula" Title="Formula" />
                                                <TemplateColumn Title="Ions" Sortable="false">
                                                    <CellTemplate>
                                                        <MudStack Row="true" Spacing="0" Style="gap: 4px; flex-wrap: wrap;">
                                                            @foreach (var ion in context.Item.IonContributions.Keys.Take(3))
                                                            {
                                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                                    @ion.ToString()
                                                                </MudChip>
                                                            }
                                                            @if (context.Item.IonContributions.Count > 3)
                                                            {
                                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                                    +@(context.Item.IonContributions.Count - 3)
                                                                </MudChip>
                                                            }
                                                        </MudStack>
                                                    </CellTemplate>
                                                </TemplateColumn>
                                            </Columns>
                                        </MudDataGrid>
                                    </MudCardContent>
                                </MudCard>
                            }
                        }
                    </div>
                </MudTabPanel>

                <!-- Raw Salts Tab -->
                <MudTabPanel Text="?? Raw Chemical Salts">
                    @{
                        var rawSalts = FilteredSaltsByType(SubstanceType.Raw);
                    }
                    
                    <div style="padding-top: 20px;">
                        @if (rawSalts.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info">
                                No raw salts match your filters.
                            </MudAlert>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Style="margin-bottom: 10px;">
                                Showing @rawSalts.Count substances
                            </MudText>
                            
                            <!-- Group by primary nutrient within Raw -->
                            @foreach (var grouping in rawSalts.GroupBy(s => s.Group).OrderBy(g => g.Key.ToString()))
                            {
                                <MudCard Style="margin-bottom: 16px;">
                                    <MudCardHeader>
                                        <CardHeaderContent>
                                            <MudText Typo="Typo.h6">@grouping.Key</MudText>
                                        </CardHeaderContent>
                                        <CardHeaderActions>
                                            <MudBadge Content="@grouping.Count()" Color="Color.Secondary" Overlap="true" Class="mx-2">
                                                <MudIcon Icon="@Icons.Material.Filled.Layers" />
                                            </MudBadge>
                                        </CardHeaderActions>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <MudDataGrid Items="@grouping.OrderBy(x => x.Name).ToList()" Hover="true" Striped="true" Dense="true" Bordered="true">
                                            <Columns>
                                                <PropertyColumn Property="x => x.Name" Title="Name" />
                                                <PropertyColumn Property="x => x.Formula" Title="Formula" />
                                                <TemplateColumn Title="Ions" Sortable="false">
                                                    <CellTemplate>
                                                        <MudStack Row="true" Spacing="0" Style="gap: 4px; flex-wrap: wrap;">
                                                            @foreach (var ion in context.Item.IonContributions.Keys.Take(3))
                                                            {
                                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                                    @ion.ToString()
                                                                </MudChip>
                                                            }
                                                            @if (context.Item.IonContributions.Count > 3)
                                                            {
                                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                                    +@(context.Item.IonContributions.Count - 3)
                                                                </MudChip>
                                                            }
                                                        </MudStack>
                                                    </CellTemplate>
                                                </TemplateColumn>
                                            </Columns>
                                        </MudDataGrid>
                                    </MudCardContent>
                                </MudCard>
                            }
                        }
                    </div>
                </MudTabPanel>
            </MudTabs>
        }
    </MudStack>
</MudContainer>

@code {
    private List<Salt>? Salts;
    private string SearchTerm = string.Empty;
    private SaltGroup? SelectedGroup;
    private int _activeTabIndex = 0;

    protected override void OnInitialized()
    {
        try
        {
            Salts = SaltService.GetAllSalts();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading substances: {ex.Message}");
        }
    }

    /// <summary>
    /// Filter salts by type (Commercial or Raw) and apply search/group filters
    /// </summary>
    private List<Salt> FilteredSaltsByType(SubstanceType type)
    {
        if (Salts == null) return new();

        return Salts
            .Where(s =>
                s.Type == type &&
                (string.IsNullOrEmpty(SearchTerm) || 
                 s.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                 s.Formula.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) &&
                (!SelectedGroup.HasValue || s.Group == SelectedGroup))
            .OrderBy(s => s.Name)
            .ToList();
    }
}
