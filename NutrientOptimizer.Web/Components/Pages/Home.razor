@page "/"
@rendermode InteractiveServer
@using NutrientOptimizer.Core
@using NutrientOptimizer.Core.Models
@using NutrientOptimizer.Core.Data
@using NutrientOptimizer.Math
@using NutrientOptimizer.Web.Services
@using NutrientOptimizer.Web.Components.Controls
@using MudBlazor
@inject SaltDatabaseService SaltService
@inject SelectedSubstancesService SelectionService
@inject WaterParametersService WaterParamsService
@inject PersistenceService PersistenceService
@implements IAsyncDisposable
    
<PageTitle>Nutrient Optimizer</PageTitle>

@if (AvailableProfiles == null || AllSalts == null)
{
    <MudStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 300px;">
        <MudProgressCircular Indeterminate="true" />
        <MudText>Loading...</MudText>
    </MudStack>
}
else if (AllSalts.Count == 0)
{
    <MudAlert Severity="Severity.Error">
        No salts loaded from database. Please ensure the database has been initialized.
    </MudAlert>
}
else
{
    <MudStack Spacing="3" Class="pa-4">
        <!-- Local Water Parameters -->
        <WaterParametersEditor Parameters="@WaterParameters" OnParametersChanged="@OnWaterParametersChanged" />

        <!-- Plant Profile Selection - Always Visible -->
        <MudPaper Elevation="0" Class="pa-6">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6" Style="font-weight: 400; letter-spacing: 0.5px;">🌱 PLANT PROFILE</MudText>
                <MudSelect T="int" 
                           Value="selectedProfileIndex" 
                           ValueChanged="OnProfileChanged"
                           Variant="Variant.Outlined" 
                           AnchorOrigin="Origin.BottomCenter"
                           Label="Please select a plant profile"
                           Dense="false">
                    @if (selectedProfileIndex == -1)
                    {
                        <MudSelectItem T="int" Value="-1">
                            <MudText Class="mud-text-secondary">Please select a plant profile</MudText>
                        </MudSelectItem>
                    }
                    @for (int i = 0; i < AvailableProfiles.Count; i++)
                    {
                        var profile = AvailableProfiles[i];
                        var index = i;
                        <MudSelectItem T="int" Value="@index">
                            <strong>@profile.Name</strong> — @profile.Description
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudStack>
        </MudPaper>

        <!-- Salt Catalog - Collapsible -->
        <MudExpansionPanel Text="📋 ALL SALTS CATALOGUE" Icon="@Icons.Material.Filled.ExpandMore" Dense="false" IsInitiallyExpanded="false">
            <MudPaper Elevation="0" Class="pa-4">
                <SaltCatalogBrowser />
            </MudPaper>
        </MudExpansionPanel>

        <!-- My Salts Inventory - Always Visible -->
        <MudPaper Elevation="1" Class="pa-6" Style="background-color: #f5f5f5;">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6" Style="font-weight: 400; letter-spacing: 0.5px;">
                        🎒 MY SALTS (@SelectedSaltsList.Count)
                    </MudText>
                    <MudSpacer />
                    @if (SelectedSaltsList.Count > 0)
                    {
                        <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small" OnClick="ClearAllSalts">
                            CLEAR ALL
                        </MudButton>
                    }
                </MudStack>

                @if (SelectedSaltsList.Count == 0)
                {
                    <MudAlert Severity="Severity.Warning">
                        No salts in inventory. Select from the catalogue above to add salts for calculation.
                    </MudAlert>
                }
                else
                {
                    <MudStack Spacing="2">
                        @{
                            var saltsByGroup = SelectedSaltsList.GroupBy(s => s.Group).OrderBy(g => g.Key.ToString());
                            var usedSalts = result?.SaltAmounts.Keys.ToHashSet() ?? new HashSet<Salt>();
                        }

                        @foreach (var grouping in saltsByGroup)
                        {
                            <MudPaper Elevation="0" Class="pa-3" Style="background-color: white; border-left: 4px solid #4caf50;">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.body2" Style="font-weight: 500; color: #556b5c;">@grouping.Key</MudText>
                                    <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                                        @foreach (var salt in grouping.OrderBy(s => s.Name))
                                        {
                                            var currentSalt = salt;
                                            var isUsed = usedSalts.Contains(salt);
                                            var chipColor = isUsed ? Color.Success : Color.Inherit;
                                            var chipStyle = isUsed ? "" : "opacity: 0.5;";
                                            
                                            <MudChip T="string" 
                                                     OnClose="@(new EventCallback(this, new Func<Task>(() => { RemoveSalt(currentSalt); return Task.CompletedTask; })))"
                                                     Color="@chipColor" 
                                                     Variant="Variant.Outlined"
                                                     Size="Size.Small"
                                                     Style="@chipStyle">
                                                @salt.Name
                                            </MudChip>
                                        }
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                }
            </MudStack>
        </MudPaper>

        <!-- Calculate Button -->
        <MudStack AlignItems="AlignItems.Center" Class="my-3">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       Size="Size.Large"
                       OnClick="Calculate"
                       Disabled="@(isButtonDisabled || selectedProfileIndex < 0 || SelectedSaltsList.Count == 0)"
                       Class="px-8"
                       Style="min-width: 280px; font-weight: 500; letter-spacing: 0.5px;">
                @if (isCalculating)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ml-2">CALCULATING...</MudText>
                }
                else if (selectedProfileIndex < 0)
                {
                    <MudText>SELECT PROFILE</MudText>
                }
                else if (SelectedSaltsList.Count == 0)
                {
                    <MudText>SELECT SALTS FROM CATALOGUE</MudText>
                }
                else
                {
                    <MudText>CALCULATE RECIPE</MudText>
                }
            </MudButton>
        </MudStack>

        <!-- Results - Always Visible (not collapsible) -->
        @if (result != null)
        {
            <MudPaper Elevation="1" Class="pa-6">
                <MudStack Spacing="3">
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.h6" Style="font-weight: 400; letter-spacing: 0.5px;">📊 CALCULATION RESULTS</MudText>
                        @if (isCalculating)
                        {
                            <MudSpacer />
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Recalculating...</MudText>
                        }
                    </MudStack>

                    <MudDivider />

                    <MudStack Spacing="3">
                        @if (result.Success)
                        {
                            <!-- Water Parameters Info -->
                            <MudPaper Elevation="0" Class="pa-4" Style="background-color: #f0f8ff; border-left: 4px solid #2196f3;">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2" Style="color: #1565c0; font-weight: 500;">💧 Water Parameters Applied</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #666;">The following ions from your local water supply have been subtracted from plant profile requirements:</MudText>
                                    <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                                        @if (WaterParameters.Nitrate > 0)
                                        {
                                            <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">NO₃⁻: @WaterParameters.Nitrate.ToString("F1") ppm</MudChip>
                                        }
                                        @if (WaterParameters.Calcium > 0)
                                        {
                                            <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">Ca²⁺: @WaterParameters.Calcium.ToString("F1") ppm</MudChip>
                                        }
                                        @if (WaterParameters.Magnesium > 0)
                                        {
                                            <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">Mg²⁺: @WaterParameters.Magnesium.ToString("F1") ppm</MudChip>
                                        }
                                        @if (WaterParameters.Potassium > 0)
                                        {
                                            <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">K⁺: @WaterParameters.Potassium.ToString("F1") ppm</MudChip>
                                        }
                                        @if (WaterParameters.Sulfur > 0)
                                        {
                                            <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">SO₄²⁻: @WaterParameters.Sulfur.ToString("F1") ppm</MudChip>
                                        }
                                        @if (WaterParameters.GetTotalDissolved() == 0)
                                        {
                                            <MudText Typo="Typo.caption" Style="color: #999; font-style: italic;">No water parameters set - using pure water baseline</MudText>
                                        }
                                    </MudStack>
                                </MudStack>
                            </MudPaper>

                            <!-- Recipe Display -->
                            <MudPaper Elevation="0" Class="pa-4" Style="background-color: #f0f7f0; border-left: 4px solid #4caf50;">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2" Style="color: #2e7d32; font-weight: 500;">✓ Recipe (g/L) - @(AvailableProfiles?[selectedProfileIndex]?.Name ?? "Unknown")</MudText>
                                    @if (result.SaltAmounts.Any())
                                    {
                                        <MudStack Spacing="1">
                                            @foreach (var kv in result.SaltAmounts.OrderBy(k => k.Key.Name))
                                            {
                                                var saltName = kv.Key.Name;
                                                var amount = kv.Value;
                                                
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudText Typo="Typo.body2" Style="min-width: 200px;">@saltName</MudText>
                                                    <MudNumericField @bind-Value="amount" 
                                                                     Label="g/L" 
                                                                     Min="0" 
                                                                     Step="0.0001"
                                                                     Variant="Variant.Outlined"
                                                                     Style="min-width: 150px;"
                                                                     @onchange="@((ChangeEventArgs e) => UpdateSaltAmount(saltName, Convert.ToDouble(e?.Value ?? 0.0d)))" />
                                                    <MudText Typo="Typo.caption" Style="color: #999;">@amount.ToString("F4")</MudText>
                                                </MudStack>
                                            }
                                        </MudStack>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">(No salts required)</MudText>
                                    }
                                </MudStack>
                            </MudPaper>

                            <!-- Requirements Summary -->
                            <MudPaper Elevation="0" Class="pa-4" Style="background-color: #fafafa; border: 1px solid #e0e0e0;">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2" Style="font-weight: 500;">📋 Ion Requirements vs Results</MudText>
                                    <MudStack Spacing="1">
                                        @foreach (var comparison in result.IonComparisons.OrderBy(c => c.Ion.ToString()))
                                        {
                                            var deviationPercent = comparison.DeltaPercent;
                                            var isGood = Math.Abs(deviationPercent) <= 10;
                                            var deviationColor = isGood ? Color.Success : Color.Warning;
                                            var deviationSign = deviationPercent >= 0 ? "+" : "";

                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudText Typo="Typo.body2" Style="min-width: 150px; font-weight: 500;">@comparison.Ion.ToString()</MudText>
                                                <MudText Typo="Typo.caption" Style="min-width: 120px;">Target: @comparison.TargetPpm.ToString("F1") ppm</MudText>
                                                <MudText Typo="Typo.caption" Style="min-width: 120px;">Result: @comparison.ActualPpm.ToString("F1") ppm</MudText>
                                                <MudChip T="string" 
                                                         Color="@deviationColor" 
                                                         Variant="Variant.Filled"
                                                         Size="Size.Small"
                                                         Style="min-width: 80px; text-align: center;">
                                                    @(deviationSign)@deviationPercent.ToString("F1")%
                                                </MudChip>
                                            </MudStack>
                                        }
                                    </MudStack>
                                </MudStack>
                            </MudPaper>

                            <!-- Chart Results -->
                            <ResultsChart Result="result" />
                        }
                        else
                        {
                            <!-- Failure Display -->
                            <MudAlert Severity="Severity.Error" Dense="false">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.body2"><strong>✗ OPTIMIZATION FAILED</strong></MudText>
                                    <MudText Typo="Typo.body2">@result.ReasonForTermination</MudText>
                                </MudStack>
                            </MudAlert>

                            <!-- Chart for Failed Solution (if partial results available) -->
                            @if (result.IonComparisons.Any())
                            {
                                <ResultsChart Result="result" />
                            }
                            else if (result.InfeasibilityReasons.Any())
                            {
                                <MudAlert Severity="Severity.Warning" Dense="false">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.subtitle2">Reasons:</MudText>
                                        @foreach (var reason in result.InfeasibilityReasons)
                                        {
                                            <MudText Typo="Typo.body2">• @reason</MudText>
                                        }
                                    </MudStack>
                                </MudAlert>
                            }
                        }
                    </MudStack>
                </MudStack>
            </MudPaper>
        }
    </MudStack>
}

@code {
    private List<PlantProfile>? AvailableProfiles;
    private List<Salt>? AllSalts;
    private WaterParameters WaterParameters = WaterParameters.CreateDefault();
    private List<Salt> SelectedSaltsList => SelectionService.GetSelectedSalts();

    private int selectedProfileIndex = -1;
    private bool isButtonDisabled = false;
    private OptimizationResult? result;
    private bool isCalculating = false;
    private bool isInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            AvailableProfiles = PlantProfileLibrary.Profiles.ToList();
            AllSalts = SaltService.GetAllSalts();
            
            // Subscribe to events FIRST
            SelectionService.OnSelectionChanged += OnSaltSelectionChanged;
            WaterParamsService.OnParametersChanged += OnWaterParametersChanged;
            
            // Load saved settings from localStorage
            var savedSettings = await PersistenceService.LoadSettingsAsync();
            if (savedSettings != null)
            {
                Console.WriteLine("Loading saved settings from localStorage");
                selectedProfileIndex = savedSettings.SelectedProfileIndex;
                WaterParameters = savedSettings.WaterParameters;
                
                // Restore selected salts
                if (savedSettings.SelectedSalts.Count > 0 && AllSalts != null)
                {
                    Console.WriteLine($"[Home] Restoring {savedSettings.SelectedSalts.Count} selected salts");
                    SelectionService.SetSelections(savedSettings.SelectedSalts, AllSalts);
                    Console.WriteLine($"[Home] Selection service now has {SelectionService.GetSelectedCount()} salts");
                }
                else
                {
                    Console.WriteLine("[Home] No salts to restore or AllSalts is null");
                }
            }
            else
            {
                Console.WriteLine("[Home] No saved settings found");
                WaterParameters = WaterParamsService.GetParameters();
            }
            
            isInitialized = true;
            Console.WriteLine("Home.razor initialized");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during initialization: {ex.Message}");
        }
    }

    private void OnProfileChanged(int value)
    {
        selectedProfileIndex = value;
        if (isInitialized)
        {
            _ = SaveSettingsAsync();
        }
    }

    private void OnSaltSelectionChanged()
    {
        Console.WriteLine($"[Home] Salt selection changed, now have {SelectionService.GetSelectedCount()} salts");
        
        if (isInitialized)
        {
            _ = SaveSettingsAsync();
        }
        
        // Force UI update
        StateHasChanged();
        
        // Auto-recalculate if we have both profile and salts selected
        if (selectedProfileIndex >= 0 && SelectedSaltsList.Count > 0 && !isCalculating)
        {
            _ = Calculate();
        }
    }

    private void OnWaterParametersChanged()
    {
        WaterParameters = WaterParamsService.GetParameters();
        Console.WriteLine($"Water parameters updated: NO₃⁻={WaterParameters.Nitrate}, Ca²⁺={WaterParameters.Calcium}, Mg²⁺={WaterParameters.Magnesium}, K⁺={WaterParameters.Potassium}, SO₄²⁻={WaterParameters.Sulfur}");
        StateHasChanged();
        if (isInitialized)
        {
            _ = SaveSettingsAsync();
        }
        // Auto-recalculate with new water parameters
        if (selectedProfileIndex >= 0 && SelectedSaltsList.Count > 0 && !isCalculating)
        {
            _ = Calculate();
        }
    }

    private async Task SaveSettingsAsync()
    {
        try
        {
            var settings = new AppSettings
            {
                SelectedProfileIndex = selectedProfileIndex,
                WaterParameters = WaterParameters,
                SelectedSalts = SelectionService.GetSelectionsForStorage(),
                LastSaved = DateTime.UtcNow
            };
            await PersistenceService.SaveSettingsAsync(settings);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving settings: {ex.Message}");
        }
    }

    private void RemoveSalt(Salt salt)
    {
        SelectionService.RemoveSalt(salt);
        // Only trigger recalculation, not full page refresh
        OnSaltSelectionChanged();
    }

    private void ClearAllSalts()
    {
        SelectionService.ClearSelection();
        OnSaltSelectionChanged();
    }

    private async Task Calculate()
    {
        if (AvailableProfiles == null || SelectedSaltsList.Count == 0) return;

        if (selectedProfileIndex < 0 || selectedProfileIndex >= AvailableProfiles.Count)
        {
            result = new OptimizationResult
            {
                Success = false,
                InfeasibilityReasons = { "Please select a valid plant profile." }
            };
            StateHasChanged();
            return;
        }

        result = null;
        isCalculating = true;
        StateHasChanged();

        await Task.Run(() =>
        {
            try
            {
                var profile = AvailableProfiles[selectedProfileIndex];
                
                // Adjust profile demands by subtracting water parameters
                var adjustedProfile = new PlantProfile
                {
                    Name = profile.Name,
                    Description = profile.Description,
                    MinEC = profile.MinEC,
                    MaxEC = profile.MaxEC,
                    IonTargets = profile.IonTargets.Select(target => new IonTarget(
                        target.Ion,
                        Math.Max(0, target.MinPpm - GetWaterIonContent(target.Ion)),
                        Math.Max(0, target.MaxPpm - GetWaterIonContent(target.Ion)),
                        target.TargetPpm.HasValue ? Math.Max(0, target.TargetPpm.Value - GetWaterIonContent(target.Ion)) : null
                    )).ToList()
                };

                var optimizer = new NutrientRecipeOptimizer(SelectedSaltsList, adjustedProfile);
                result = optimizer.Solve();
            }
            catch (Exception ex)
            {
                result = new OptimizationResult
                {
                    Success = false,
                    InfeasibilityReasons = { $"Calculation error: {ex.Message}" }
                };
            }
        });

        isCalculating = false;
        StateHasChanged();
    }

    private double GetWaterIonContent(Ion ion)
    {
        return ion switch
        {
            Ion.Nitrate => WaterParameters.Nitrate,
            Ion.Calcium => WaterParameters.Calcium,
            Ion.Magnesium => WaterParameters.Magnesium,
            Ion.Potassium => WaterParameters.Potassium,
            Ion.Sulfate => WaterParameters.Sulfur,
            _ => 0
        };
    }

    private void UpdateSaltAmount(string saltName, double newAmount)
    {
        if (result?.SaltAmounts == null) return;

        var saltToUpdate = result.SaltAmounts.Keys.FirstOrDefault(s => s.Name == saltName);
        if (saltToUpdate != null)
        {
            result.SaltAmounts[saltToUpdate] = newAmount;
            // Recalculate ion comparisons based on new salt amounts
            RecalculateIonComparisons();
            StateHasChanged();
        }
    }

    private void RecalculateIonComparisons()
    {
        if (result?.SaltAmounts == null || SelectedSaltsList.Count == 0) return;

        // Recalculate actual ion concentrations from modified salt amounts
        var ionConcentrations = new Dictionary<Ion, double>();
        foreach (var salt in result.SaltAmounts.Keys)
        {
            double gramsPerLiter = result.SaltAmounts[salt];
            foreach (var (ion, massPerMole) in salt.IonContributions)
            {
                double coeff = massPerMole * 1000.0 / salt.MolecularWeight;
                double ppm = gramsPerLiter * coeff;

                if (!ionConcentrations.ContainsKey(ion))
                    ionConcentrations[ion] = 0;

                ionConcentrations[ion] += ppm;
            }
        }

        // Update ion comparisons
        foreach (var comparison in result.IonComparisons)
        {
            comparison.ActualPpm = ionConcentrations.GetValueOrDefault(comparison.Ion, 0.0);
            comparison.DeltaPpm = comparison.ActualPpm - comparison.TargetPpm;
            comparison.InRange = comparison.ActualPpm >= comparison.TargetPpm - 1 && 
                                comparison.ActualPpm <= comparison.TargetPpm + 1;
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        SelectionService.OnSelectionChanged -= OnSaltSelectionChanged;
        WaterParamsService.OnParametersChanged -= OnWaterParametersChanged;
        // Save settings one last time on dispose
        await SaveSettingsAsync();
    }
}