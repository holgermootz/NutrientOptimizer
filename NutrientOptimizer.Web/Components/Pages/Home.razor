@page "/"
@rendermode InteractiveServer
@using NutrientOptimizer.Core
@using NutrientOptimizer.Core.Models
@using NutrientOptimizer.Core.Data
@using NutrientOptimizer.Math
@using NutrientOptimizer.Web.Services
@using MudBlazor
@inject SaltDatabaseService SaltService
    
<PageTitle>Nutrient Optimizer</PageTitle>

@if (AvailableProfiles == null || AllSalts == null)
{
    <MudStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 300px;">
        <MudProgressCircular Indeterminate="true" />
        <MudText>Loading...</MudText>
    </MudStack>
}
else if (AllSalts.Count == 0)
{
    <MudAlert Severity="Severity.Error">
        No salts loaded from database. Please ensure the database has been initialized.
    </MudAlert>
}
else
{
    <MudStack Spacing="3">
        <!-- Plant Profile Selection -->
        <MudPaper Elevation="0" Class="pa-6 mb-6">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6" Style="font-weight: 400; letter-spacing: 0.5px;">PLANT PROFILE</MudText>
                @if (AvailableProfiles != null)
                {
                    <MudSelect T="int" 
                               Value="selectedProfileIndex" 
                               ValueChanged="OnProfileChanged"
                               Variant="Variant.Outlined" 
                               AnchorOrigin="Origin.BottomCenter"
                               Label="Please select a plant profile"
                               Dense="false">
                        @if (selectedProfileIndex == -1)
                        {
                            <MudSelectItem T="int" Value="-1">
                                <MudText Class="mud-text-secondary">Please select a plant profile</MudText>
                            </MudSelectItem>
                        }
                        @for (int i = 0; i < AvailableProfiles.Count; i++)
                        {
                            var profile = AvailableProfiles[i];
                            var index = i;
                            <MudSelectItem T="int" Value="@index">
                                <strong>@profile.Name</strong> — @profile.Description
                            </MudSelectItem>
                        }
                    </MudSelect>
                }
            </MudStack>
        </MudPaper>

        <!-- Salt Selection -->
        <MudPaper Elevation="0" Class="pa-6 mb-6">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6" Style="font-weight: 400; letter-spacing: 0.5px;">AVAILABLE SALTS (@AllSalts.Count)</MudText>
                
                @{
                    var groupedSalts = AllSalts.GroupBy(s => s.Category).OrderBy(g => g.Key);
                }

                @foreach (var categoryGroup in groupedSalts)
                {
                    var categoryKey = $"cat_{categoryGroup.Key}";
                    <MudExpansionPanel @key="categoryKey" DefaultExpanded="true">
                        <TitleContent>
                            <MudText Typo="Typo.subtitle2" Style="font-weight: 500; letter-spacing: 0.3px; color: #556b5c;">
                                @(categoryGroup.Key == SaltCategory.Macronutrient ? "🌾 MACRONUTRIENTS" : "🔬 MICRONUTRIENTS")
                            </MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudStack Spacing="1">
                                @{
                                    var saltGroups = categoryGroup.GroupBy(s => s.Group).OrderBy(g => g.Key);
                                }

                                @foreach (var saltGroup in saltGroups)
                                {
                                    var groupKey = $"group_{saltGroup.Key}";
                                    var groupName = GetGroupDisplayName(saltGroup.Key);
                                    
                                    <MudExpansionPanel @key="groupKey" Dense="true">
                                        <TitleContent>
                                            <MudText Typo="Typo.body2" Style="font-weight: 500; letter-spacing: 0.2px;">
                                                @groupName (@saltGroup.Count())
                                            </MudText>
                                        </TitleContent>
                                        <ChildContent>
                                            <MudGrid Spacing="2">
                                                @{
                                                    var sortedSalts = saltGroup
                                                        .OrderByDescending(s => s.IonContributions.Values.Max())
                                                        .ToList();
                                                }

                                                @foreach (var salt in sortedSalts)
                                                {
                                                    var saltIndex = AllSalts.IndexOf(salt);
                                                    var maxIon = GetMaxIonInfo(salt);
                                                    
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox T="bool" 
                                                                     Value="selectedSalts[saltIndex]"
                                                                     ValueChanged="@(async (bool newValue) => await OnSaltChanged(saltIndex, newValue))"
                                                                     Dense="false"
                                                                     Class="mud-width-full">
                                                            <MudStack Spacing="1" Class="mud-width-full">
                                                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@salt.Name</MudText>
                                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@salt.Formula</MudText>
                                                                <MudText Typo="Typo.caption" Style="color: #7a8a7d; font-size: 0.75rem;">
                                                                    ✓ @salt.GetIonSummary()
                                                                </MudText>
                                                                <MudText Typo="Typo.caption" Style="color: #9db5a8; font-size: 0.7rem;">
                                                                    Primary: @maxIon.ionName (@maxIon.amount:F2 g/mol)
                                                                </MudText>
                                                            </MudStack>
                                                        </MudCheckBox>
                                                    </MudItem>
                                                }
                                            </MudGrid>
                                        </ChildContent>
                                    </MudExpansionPanel>
                                }
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                }
            </MudStack>
        </MudPaper>

        <!-- Calculate Button -->
        <MudStack AlignItems="AlignItems.Center" Class="my-6">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       Size="Size.Large"
                       OnClick="Calculate"
                       Disabled="@(isButtonDisabled || selectedProfileIndex < 0)"
                       Class="px-8"
                       Style="min-width: 280px; font-weight: 500; letter-spacing: 0.5px;">
                @if (isCalculating)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ml-2">CALCULATING...</MudText>
                }
                else if (selectedProfileIndex < 0)
                {
                    <MudText>SELECT PROFILE & SALTS</MudText>
                }
                else if (isButtonDisabled)
                {
                    <MudText>SELECT SALTS TO CONTINUE</MudText>
                }
                else
                {
                    <MudText>CALCULATE RECIPE</MudText>
                }
            </MudButton>
        </MudStack>

        <!-- Results Section -->
        @if (result != null)
        {
            <MudPaper Elevation="0" Class="pa-6 mt-8">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6" Style="font-weight: 400; letter-spacing: 0.5px;">OPTIMIZATION RESULT</MudText>

                    @if (result.InfeasibilityReasons.Any())
                    {
                        <MudAlert Severity="Severity.Warning" Dense="false" Class="mt-4">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body2"><strong>NOTES</strong></MudText>
                                @foreach (var reason in result.InfeasibilityReasons)
                                {
                                    <MudText Typo="Typo.body2" Style="font-size: 0.9rem;">• @reason</MudText>
                                }
                            </MudStack>
                        </MudAlert>
                    }

                    <MudPaper Elevation="0" Class="pa-4 mt-4" Style="background-color: #fafaf8; border: 1px solid #e8e8e3;">
                        @if (result.Success)
                        {
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.body1"><strong>✓ SUCCESS</strong></MudText>
                                <MudDivider />
                                <MudText Typo="Typo.body2" Style="white-space: pre-line; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6;">@result.ToString()</MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.body1" Color="Color.Error"><strong>✗ FAILED</strong></MudText>
                                <MudDivider />
                                <MudText Typo="Typo.body2" Style="white-space: pre-line; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6;">@result.ToString()</MudText>
                            </MudStack>
                        }
                    </MudPaper>
                </MudStack>
            </MudPaper>
        }
    </MudStack>
}

@code {
    private List<PlantProfile>? AvailableProfiles;
    private List<Salt>? AllSalts;

    private int selectedProfileIndex = -1;
    private List<bool> selectedSalts = new();
    private bool isButtonDisabled = true;

    private OptimizationResult? result;
    private bool isCalculating = false;

    protected override void OnInitialized()
    {
        try
        {
            AvailableProfiles = PlantProfileLibrary.Profiles.ToList();
            AllSalts = SaltService.GetAllSalts();

            selectedSalts = new List<bool>(new bool[AllSalts?.Count ?? 0]);
            isButtonDisabled = true;

            Console.WriteLine($"Loaded {AllSalts?.Count ?? 0} salts from database");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during initialization: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private void OnProfileChanged(int value)
    {
        selectedProfileIndex = value;
    }

    private void UpdateButtonState()
    {
        bool hasSelection = selectedSalts.Any(s => s);
        isButtonDisabled = isCalculating || !hasSelection;
    }

    private async Task OnSaltChanged(int index, bool newValue)
    {
        selectedSalts[index] = newValue;
        UpdateButtonState();
        StateHasChanged();
    }

    private async Task Calculate()
    {
        if (AvailableProfiles == null || AllSalts == null) return;

        if (selectedProfileIndex < 0 || selectedProfileIndex >= AvailableProfiles.Count)
        {
            result = new OptimizationResult
            {
                Success = false,
                InfeasibilityReasons = { "Please select a valid plant profile." }
            };
            StateHasChanged();
            return;
        }

        result = null;
        isCalculating = true;
        StateHasChanged();

        await Task.Run(() =>
        {
            try
            {
                var profile = AvailableProfiles[selectedProfileIndex];

                var selectedSaltList = new List<Salt>();
                for (int i = 0; i < selectedSalts.Count; i++)
                {
                    if (selectedSalts[i] && i < AllSalts.Count)
                    {
                        selectedSaltList.Add(AllSalts[i]);
                    }
                }

                if (!selectedSaltList.Any())
                {
                    result = new OptimizationResult
                    {
                        Success = false,
                        InfeasibilityReasons = { "Please select at least one salt." }
                    };
                    return;
                }

                var optimizer = new NutrientRecipeOptimizer(selectedSaltList, profile);
                result = optimizer.Solve();
            }
            catch (Exception ex)
            {
                result = new OptimizationResult
                {
                    Success = false,
                    InfeasibilityReasons = { $"Calculation error: {ex.Message}" }
                };
            }
        });

        isCalculating = false;
        StateHasChanged();
    }

    private string GetGroupDisplayName(SaltGroup group)
    {
        return group switch
        {
            SaltGroup.NitrogenSource => "Nitrogen Sources",
            SaltGroup.PhosphorusSource => "Phosphorus Sources",
            SaltGroup.PotassiumSource => "Potassium Sources",
            SaltGroup.CalciumSource => "Calcium Sources",
            SaltGroup.MagnesiumSource => "Magnesium Sources",
            SaltGroup.SulfurSource => "Sulfur Sources",
            SaltGroup.IronSource => "Iron Sources",
            SaltGroup.ManganeseSource => "Manganese Sources",
            SaltGroup.ZincSource => "Zinc Sources",
            SaltGroup.CopperSource => "Copper Sources",
            SaltGroup.BoronSource => "Boron Sources",
            SaltGroup.MolybdenumSource => "Molybdenum Sources",
            _ => group.ToString()
        };
    }

    private (string ionName, double amount) GetMaxIonInfo(Salt salt)
    {
        var maxIon = salt.IonContributions.OrderByDescending(x => x.Value).First();
        return (maxIon.Key.ToString(), maxIon.Value);
    }
}