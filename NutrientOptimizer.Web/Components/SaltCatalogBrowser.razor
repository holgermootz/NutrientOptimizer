@using NutrientOptimizer.Core
@using NutrientOptimizer.Core.Data
@using NutrientOptimizer.Web.Services
@using MudBlazor

@inject SaltDatabaseService SaltService
@inject SelectedSubstancesService SelectionService
@implements IDisposable

<MudStack Spacing="3">
    <!-- Search and Filter -->
    <MudStack Row="true" Spacing="2">
        <MudTextField @bind-Value="SearchTerm" Placeholder="Search substances..." 
            Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" 
            Style="flex: 1;" />
        
        <MudSelect @bind-Value="SelectedGroup" Label="Filter by Group" Variant="Variant.Filled" Style="min-width: 200px;">
            <MudSelectItem Value="@(null as SaltGroup?)">All Groups</MudSelectItem>
            @foreach (var group in Enum.GetValues(typeof(SaltGroup)).Cast<SaltGroup>())
            {
                <MudSelectItem Value="@((SaltGroup?)group)">@group</MudSelectItem>
            }
        </MudSelect>
    </MudStack>

    <!-- Tabs for Commercial vs Raw -->
    <MudTabs Elevation="0" ActivePanelIndex="@_activeTabIndex" ApplyEffectsToContainer="true">
        <!-- Commercial Fertilizers Tab -->
        <MudTabPanel Text="?? Commercial Fertilizers">
            @{
                var commercialSalts = FilteredSaltsByType(SubstanceType.Commercial);
            }
            
            <div style="padding-top: 20px;">
                @if (commercialSalts.Count == 0)
                {
                    <MudAlert Severity="Severity.Info">
                        No commercial fertilizers match your filters.
                    </MudAlert>
                }
                else
                {
                    <MudText Typo="Typo.caption" Style="margin-bottom: 10px;">
                        Showing @commercialSalts.Count substances
                    </MudText>
                    
                    <!-- Group by primary nutrient - Collapsible -->
                    @foreach (var grouping in commercialSalts.GroupBy(s => s.Group).OrderBy(g => g.Key.ToString()))
                    {
                        <MudExpansionPanel Text="@grouping.Key.ToString()" Dense="false">
                            <ChildContent>
                                <MudStack Spacing="2">
                                    @foreach (var salt in grouping.OrderBy(x => x.Name))
                                    {
                                        var isSelected = SelectionService.IsSelected(salt);
                                        var bgStyle = isSelected ? "background-color: #e8f5e9; border: 2px solid #4caf50; cursor: pointer;" : "border: 1px solid #e0e0e0; cursor: pointer;";
                                        <MudPaper Class="pa-3" Elevation="@(isSelected ? 2 : 0)" Style="@bgStyle">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" @onclick="@(() => ShowSaltDetails(salt))" Style="cursor: pointer;">
                                                <MudCheckBox T="bool" Value="@isSelected" ValueChanged="@((bool value) => OnSaltToggled(salt))" />
                                                <MudStack Spacing="0" Style="flex: 1;">
                                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@salt.Name</MudText>
                                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@salt.Formula</MudText>
                                                    <MudText Typo="Typo.caption" Style="color: #7a8a7d; font-size: 0.75rem;">
                                                        ? @salt.GetIonSummary()
                                                    </MudText>
                                                </MudStack>
                                                @if (isSelected)
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                                }
                                            </MudStack>
                                        </MudPaper>
                                    }
                                </MudStack>
                            </ChildContent>
                        </MudExpansionPanel>
                    }
                }
            </div>
        </MudTabPanel>

        <!-- Raw Salts Tab -->
        <MudTabPanel Text="?? Raw Chemical Salts">
            @{
                var rawSalts = FilteredSaltsByType(SubstanceType.Raw);
            }
            
            <div style="padding-top: 20px;">
                @if (rawSalts.Count == 0)
                {
                    <MudAlert Severity="Severity.Info">
                        No raw salts match your filters.
                    </MudAlert>
                }
                else
                {
                    <MudText Typo="Typo.caption" Style="margin-bottom: 10px;">
                        Showing @rawSalts.Count substances
                    </MudText>
                    
                    <!-- Group by primary nutrient - Collapsible -->
                    @foreach (var grouping in rawSalts.GroupBy(s => s.Group).OrderBy(g => g.Key.ToString()))
                    {
                        <MudExpansionPanel Text="@grouping.Key.ToString()" Dense="false">
                            <ChildContent>
                                <MudStack Spacing="2">
                                    @foreach (var salt in grouping.OrderBy(x => x.Name))
                                    {
                                        var isSelected = SelectionService.IsSelected(salt);
                                        var bgStyle = isSelected ? "background-color: #e8f5e9; border: 2px solid #4caf50; cursor: pointer;" : "border: 1px solid #e0e0e0; cursor: pointer;";
                                        <MudPaper Class="pa-3" Elevation="@(isSelected ? 2 : 0)" Style="@bgStyle">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" @onclick="@(() => ShowSaltDetails(salt))" Style="cursor: pointer;">
                                                <MudCheckBox T="bool" Value="@isSelected" ValueChanged="@((bool value) => OnSaltToggled(salt))" />
                                                <MudStack Spacing="0" Style="flex: 1;">
                                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@salt.Name</MudText>
                                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@salt.Formula</MudText>
                                                    <MudText Typo="Typo.caption" Style="color: #7a8a7d; font-size: 0.75rem;">
                                                        ? @salt.GetIonSummary()
                                                    </MudText>
                                                </MudStack>
                                                @if (isSelected)
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                                }
                                            </MudStack>
                                        </MudPaper>
                                    }
                                </MudStack>
                            </ChildContent>
                        </MudExpansionPanel>
                    }
                }
            </div>
        </MudTabPanel>
    </MudTabs>
</MudStack>

@code {
    private List<Salt>? AllSalts;
    private string SearchTerm = string.Empty;
    private SaltGroup? SelectedGroup;
    private int _activeTabIndex = 0;

    protected override void OnInitialized()
    {
        try
        {
            AllSalts = SaltService.GetAllSalts();
            SelectionService.OnSelectionChanged += StateHasChanged;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading salts: {ex.Message}");
        }
    }

    private void OnSaltToggled(Salt salt)
    {
        SelectionService.ToggleSalt(salt);
        StateHasChanged();
    }

    private void ShowSaltDetails(Salt salt)
    {
        // TODO: Show salt details component/dialog
        Console.WriteLine($"Show details for {salt.Name}");
    }

    private List<Salt> FilteredSaltsByType(SubstanceType type)
    {
        if (AllSalts == null) return new();

        return AllSalts
            .Where(s =>
                s.Type == type &&
                (string.IsNullOrEmpty(SearchTerm) || 
                 s.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                 s.Formula.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) &&
                (!SelectedGroup.HasValue || s.Group == SelectedGroup))
            .OrderBy(s => s.Name)
            .ToList();
    }

    void IDisposable.Dispose()
    {
        SelectionService.OnSelectionChanged -= StateHasChanged;
    }
}
